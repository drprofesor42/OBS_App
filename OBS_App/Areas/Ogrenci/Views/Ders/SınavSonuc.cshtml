@{
	ViewData["Title"] = "SınavSonuc";
}
@model List<Not>

<div class="content container-fluid">
    <div class="row">
        @if (Model.Count() != 0)
        {
            @foreach (var ders in Model.OrderByDescending(s => s.NotTip).GroupBy(s => s.Ders))
            {

                // Dersin notlarını al
                var dersNotlari = ders.ToList();

                // Notların ağırlıklı ortalamasını hesapla
                var notOrtalamasi = CalculateWeightedAverage(dersNotlari);

                <div class="col-sm-6 col-lg-4 col-xl-4 d-flex">
                    <div class="card invoices-grid-card w-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <a style="font-weight:bold; font-size:15px" href="view-invoice.html" class="invoice-grid-link">@ders.Key?.DersAd</a>
                            @if (ders.Count() == 3)
                                @if (notOrtalamasi >= 50)
                                {
                                    <h6 class="text-end text-success">Geçtiniz</h6>
                                }
                                else
                                {
                                    <h6 class="text-end text-danger">Kaldınız</h6>
                                }
                        </div>
                        <div class="card-middle">
                            <h2 class="card-middle-avatar">
                                <a><img class="avatar avatar-sm me-2 avatar-img rounded-circle" src="~/panel/img/profiles/avatar-04.jpg" alt="User Image"> @ders.First().Ogretmens?.OgretmenAd @ders.First().Ogretmens?.OgretmenSoyad</a>
                            </h2>
                        </div>
                        <div class="card-body">

                            <div class="progress progress-md">
                                <div class="progress-bar bg-success" role="progressbar" style="width: @notOrtalamasi%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <table style="width:100%;">
                                <tbody>
                                    <tr>
                                        <td style="font-size:10px;  text-align:center;">
                                            <div>
                                                Ortalamanız : <span style="color:#00711b">@notOrtalamasi</span>
                                            </div>
                                        </td>
                                        <td style="font-size:10px; text-align:center;">
                                            Sınıf Ortalaması : <span style="color:#00711b">x</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <br />

                            <div class="row align-items-center">
                                <div style="text-align:start; margin-left:5px" class="col">
                                    <span><i class="far fa-file-lines"></i> Sınav</span>
                                </div>
                                <div style="text-align:start; margin-right:5px" class="col">
                                    <span><i class="fas fa-pencil"></i> Sonuç</span>
                                </div>
                                <div style="text-align:start; margin-right:10px" class="col">
                                    <span><i class="far fa-clock"></i> Saat</span>
                                </div>
                                <div style="text-align:start; margin-right:15px" class="col-auto">
                                    <span><i class="far fa-calendar-alt"></i> Tarih</span>
                                </div>
                            </div>

                            @foreach (var sınav in ders)
                            {
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h6 style="text-align:center" class="mb-0">@sınav.NotTip</h6>
                                    </div>
                                    <div class="col">
                                        <h6 style="text-align:center" class="mb-0">@sınav.NotPuan</h6>
                                    </div>
                                    <div class="col">
                                        <h6 style="text-align:center" class="mb-0">@sınav.NotSaat</h6>
                                    </div>
                                    <div class="col-auto">
                                        <h6 style="text-align:center" class="mb-0">@sınav.NotTarihi</h6>
                                    </div>
                                </div>
                                <br>
                            }

                        </div>
                        <div class="card-footer">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    @if (ders.Count() == 3)
                                    {
                                        <span class="badge bg-success-dark">Bitti</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-gradient-warning">Devam Ediyor</span>
                                    }
                                </div>
                                <div class="col text-end">
                                    <h5 style="color:royalblue">Harf Notu: @CalculateLetterGrade(notOrtalamasi)</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="blog grid-blog flex-fill">
                <h3 class="text-danger" style="text-align:center"> Sınav Bilgisi Bulunmamaktadır! </h3>
            </div>
        }
    </div>
</div>

@functions {
    private decimal CalculateWeightedAverage(List<Not> notlar)
    {
        decimal toplamNot = 0;
        decimal toplamAgirlik = 0;

        foreach (var not in notlar)
        {
            switch (not.NotTip)
            {
                case "Ödev":
                    toplamNot += (not.NotPuan ?? 0) * 0.25m;
                    toplamAgirlik += 0.25m;
                    break;
                case "Vize":
                    toplamNot += (not.NotPuan ?? 0) * 0.35m;
                    toplamAgirlik += 0.35m;
                    break;
                case "Final":
                    toplamNot += (not.NotPuan ?? 0) * 0.40m;
                    toplamAgirlik += 0.40m;
                    break;
                default:
                    // Belirtilmeyen not tipleri için bir şey yapma
                    break;
            }
        }

        decimal ortalama = toplamAgirlik != 0 ? toplamNot / toplamAgirlik : 0;
        return Math.Round(ortalama); // Ondalık basamakları 2'ye yuvarla
    }

    private string CalculateLetterGrade(decimal ortalama)
    {
        if (ortalama >= 90)
            return "AA";
        else if (ortalama >= 80)
            return "BA";
        else if (ortalama >= 75)
            return "BB";
        else if (ortalama >= 70)
            return "CB";
        else if (ortalama >= 60)
            return "CC";
        else if (ortalama >= 50)
            return "DC";
        else if (ortalama >= 40)
            return "DD";
        else if (ortalama >= 30)
            return "FD";
        else
            return "FF";
    }
}

